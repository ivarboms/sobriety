<h1>Sobriety Detector</h1>

<div class="icon-container">
    <div class="fingerprint-image"></div>
    <div class="scanner"></div>
    <div class="description"></div>
</div>

<style>
    :root {
        --icon-width: 250px;
        --scanner-width: calc(var(--icon-width) * 0.15);
        --start-x: calc(0 - (var(--icon-width) + var(--scanner-width)));
        --end-x: calc(var(--icon-width) - var(--scanner-width));

        --base-offset: calc(var(--scanner-width) * -0.5);
        --scan-offset: calc(var(--icon-width) * 0.5);
    }

    .icon {
        width: var(--icon-width);
        height: var(--icon-width);
        grid-column: 2;
        grid-row: 3;
    }
    .scanner {
        grid-column: 2;
        grid-row: 3;
        background-color: #18c89b;
        width: var(--scanner-width);
        height: calc(var(--icon-width) * 1.2);
        justify-self: start;
        box-shadow: 0px 0px 20px 5px rgba(45,255,196,0.9);
        opacity: 0;
        transition: 200ms;
        margin-left: calc(var(--icon-width) * 0.5);
    }
    .scanner.scanning {
        animation: scan 1.3s linear infinite alternate;
        opacity: 1;
    }
    .icon-container {
        display: grid;
        grid-template-columns: 1fr 250px 1fr;
        grid-template-rows: 2fr 1fr 1fr;
        align-items: center;
        justify-items: center;
        height: 80vh;
    }
    .fingerprint-image {
        background-image: url(fingerprint.png);
        background-size: contain;
        display: block;
        width: var(--icon-width);
        height: var(--icon-width);
        grid-column: 2;
        grid-row: 3;
    }
    @keyframes scan {
        0% {
            transform: translateX(calc(var(--scan-offset) * -1.2));
        }
        50% {
            transform: translateX(var(--scan-offset));
        }
        50.1% {
            transform: translateX(var(--base-offset))
                translateY(calc(var(--scan-offset)))
                rotateZ(90deg);
        }
        100% {
            transform: translateX(var(--base-offset))
                translateY(calc(var(--scan-offset) * -1.2))
                rotateZ(90deg);
        }
    }

    .description {
        grid-column: 2;
        grid-row: 2;
        font-size: 40px;
        width: 250%;
    }
    h1 {
        display: grid;
        grid-template-columns: 1fr;
        justify-self: center;
        font-size: 80px;
    }

    body {
        background-color: #666;
    }
    body.flash {
        animation: 200ms flash linear;
        animation-iteration-count: 5;
    }
    @keyframes flash {
        0% {
            background-color: none;
        }
        50% {
            background-color: #f22;
        }
        100% {
            background-color: none;
        }
    }
</style>

<script>
    const container = document.querySelector('.icon-container');
    const text = document.querySelector('.description');
    const scanner = document.querySelector('.scanner');
    const fingerprint = document.querySelector('.fingerprint-image');
    const scanningClassName = 'scanning';

    const texts = [
        'Scanning fingerprint',
        'Analyzing DNA',
        'Detecting substances',
        'Computing sobriety',
        'Sobriety not detected',
    ];
    let currentTextIndex = -1;
    let updateTimerId = -1;

    let isCurrentlyScanning = false;
    const startScan = () => {
        scanner.classList.add(scanningClassName);
        isCurrentlyScanning = true;

        text.replaceChildren();
        currentTextIndex = -1;
        updateTexts();
    }
    const endScan = () => {
        if (!isCurrentlyScanning) {
            // Don't flash twice (when holding until the end of animation AND on release).
            return;
        }
        scanner.classList.remove(scanningClassName);
        document.body.classList.add('flash');
        const result = navigator.vibrate(200);
        document.querySelector('h1').textContent += 'vibrate: ' + result;

        clearTimeout(updateTimerId);

        setTimeout(() => {
            document.body.classList.remove('flash');
            isCurrentlyScanning = false;
        }, 500);
    }

    async function updateTexts(delayMs = 1000) {
        if (currentTextIndex < texts.length - 1) {
            const lastTextLine = text.querySelector('div:last-child');
            if (lastTextLine) {
                lastTextLine.textContent += ' âœ…';
            }
            currentTextIndex++;
            const line = document.createElement('div');
            line.textContent = texts[currentTextIndex];
            text.appendChild(line);
            if (currentTextIndex === texts.length - 1) {
                endScan();
            }
            updateTimerId = setTimeout(updateTexts, delayMs);
        }
    }

    if ('ontouchstart' in window) {
        // phone
        fingerprint.ontouchstart = startScan;
        fingerprint.ontouchend = endScan;
        fingerprint.ontouchcancel = endScan;
    } else {
        // computer
        fingerprint.onmousedown = startScan;
        fingerprint.onmouseup = endScan;
    }
</script>